{% extends 'base.html' %}
{% load static %}

{% block title %}{{ object.pk|yesno:"Editar,Nuevo" }} Producto{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">{{ object.pk|yesno:"Editar,Nuevo" }} Producto</h3>
                        <a href="{% url 'productos:producto_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% include "productos/components/_form_errors.html" %}
                    
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {# Información General #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Información General</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.codigo.id_for_label }}" class="form-label">Código *</label>
                                        {{ form.codigo }}
                                        {% if form.codigo.errors %}
                                        <div class="invalid-feedback">{{ form.codigo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre *</label>
                                        {{ form.nombre }}
                                        {% if form.nombre.errors %}
                                        <div class="invalid-feedback">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.unidad_medida.id_for_label }}" class="form-label">Unidad de Medida *</label>
                                        {{ form.unidad_medida }}
                                        {% if form.unidad_medida.errors %}
                                        <div class="invalid-feedback">{{ form.unidad_medida.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.categoria.id_for_label }}" class="form-label">Categoría *</label>
                                        {{ form.categoria }}
                                        {% if form.categoria.errors %}
                                        <div class="invalid-feedback">{{ form.categoria.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.subcategoria.id_for_label }}" class="form-label">Subcategoría</label>
                                        {{ form.subcategoria }}
                                        {% if form.subcategoria.errors %}
                                        <div class="invalid-feedback">{{ form.subcategoria.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.estado.id_for_label }}" class="form-label">Estado *</label>
                                        {{ form.estado }}
                                        {% if form.estado.errors %}
                                        <div class="invalid-feedback">{{ form.estado.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-check">
                                            {{ form.comercializable }}
                                            <label class="form-check-label" for="{{ form.comercializable.id_for_label }}">
                                                Producto Comercializable
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Material y Dimensiones #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Material y Dimensiones</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.tipo_material.id_for_label }}" class="form-label">Tipo Material *</label>
                                        {{ form.tipo_material }}
                                        {% if form.tipo_material.errors %}
                                        <div class="invalid-feedback">{{ form.tipo_material.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.tipo_materia_prima.id_for_label }}" class="form-label">Materia Prima *</label>
                                        {{ form.tipo_materia_prima }}
                                        {% if form.tipo_materia_prima.errors %}
                                        <div class="invalid-feedback">{{ form.tipo_materia_prima.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.color.id_for_label }}" class="form-label">Color</label>
                                        {{ form.color }}
                                        {% if form.color.errors %}
                                        <div class="invalid-feedback">{{ form.color.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.calibre_um.id_for_label }}" class="form-label">Calibre (µm)</label>
                                        {{ form.calibre_um }}
                                        {% if form.calibre_um.errors %}
                                        <div class="invalid-feedback">{{ form.calibre_um.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.medida_en.id_for_label }}" class="form-label">Medida En</label>
                                        {{ form.medida_en }}
                                        {% if form.medida_en.errors %}
                                        <div class="invalid-feedback">{{ form.medida_en.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.factor_decimal.id_for_label }}" class="form-label">Factor Decimal</label>
                                        {{ form.factor_decimal }}
                                        {% if form.factor_decimal.errors %}
                                        <div class="invalid-feedback">{{ form.factor_decimal.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="{{ form.largo.id_for_label }}" class="form-label">Largo</label>
                                        {{ form.largo }}
                                        {% if form.largo.errors %}
                                        <div class="invalid-feedback">{{ form.largo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.ancho.id_for_label }}" class="form-label">Ancho</label>
                                        {{ form.ancho }}
                                        {% if form.ancho.errors %}
                                        <div class="invalid-feedback">{{ form.ancho.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.ancho_rollo.id_for_label }}" class="form-label">Ancho Rollo</label>
                                        {{ form.ancho_rollo }}
                                        {% if form.ancho_rollo.errors %}
                                        <div class="invalid-feedback">{{ form.ancho_rollo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Impresión #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Impresión</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.imp_tipo_impresion.id_for_label }}" class="form-label">Tipo de Impresión</label>
                                        {{ form.imp_tipo_impresion }}
                                        {% if form.imp_tipo_impresion.errors %}
                                        <div class="invalid-feedback">{{ form.imp_tipo_impresion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.tipo_tinta.id_for_label }}" class="form-label">Tipo de Tinta</label>
                                        {{ form.tipo_tinta }}
                                        {% if form.tipo_tinta.errors %}
                                        <div class="invalid-feedback">{{ form.tipo_tinta.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="{{ form.imp_rodillo.id_for_label }}" class="form-label">Rodillo</label>
                                        {{ form.imp_rodillo }}
                                        {% if form.imp_rodillo.errors %}
                                        <div class="invalid-feedback">{{ form.imp_rodillo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.imp_repeticiones.id_for_label }}" class="form-label">Repeticiones</label>
                                        {{ form.imp_repeticiones }}
                                        {% if form.imp_repeticiones.errors %}
                                        <div class="invalid-feedback">{{ form.imp_repeticiones.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Sellado #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Sellado</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_tipo.id_for_label }}" class="form-label">Tipo de Sellado</label>
                                        {{ form.sellado_tipo }}
                                        {% if form.sellado_tipo.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_tipo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_peso_millar.id_for_label }}" class="form-label">Peso Millar (kg)</label>
                                        {{ form.sellado_peso_millar }}
                                        {% if form.sellado_peso_millar.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_peso_millar.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_solapa_cm.id_for_label }}" class="form-label">Solapa (cm)</label>
                                        {{ form.sellado_solapa_cm }}
                                        {% if form.sellado_solapa_cm.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_solapa_cm.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_fuelle_fondo.id_for_label }}" class="form-label">Fuelle Fondo (cm)</label>
                                        {{ form.sellado_fuelle_fondo }}
                                        {% if form.sellado_fuelle_fondo.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_fuelle_fondo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_fuelle_lateral.id_for_label }}" class="form-label">Fuelle Lateral (cm)</label>
                                        {{ form.sellado_fuelle_lateral }}
                                        {% if form.sellado_fuelle_lateral.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_fuelle_lateral.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.sellado_fuelle_superior.id_for_label }}" class="form-label">Fuelle Superior (cm)</label>
                                        {{ form.sellado_fuelle_superior }}
                                        {% if form.sellado_fuelle_superior.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_fuelle_superior.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Features Adicionales #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Features Adicionales</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_troquel_tipo.id_for_label }}" class="form-label">Tipo Troquel</label>
                                        {{ form.sellado_troquel_tipo }}
                                        {% if form.sellado_troquel_tipo.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_troquel_tipo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_troquel_medida.id_for_label }}" class="form-label">Medida Troquel (cm)</label>
                                        {{ form.sellado_troquel_medida }}
                                        {% if form.sellado_troquel_medida.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_troquel_medida.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_zipper_tipo.id_for_label }}" class="form-label">Tipo Zipper</label>
                                        {{ form.sellado_zipper_tipo }}
                                        {% if form.sellado_zipper_tipo.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_zipper_tipo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_zipper_medida.id_for_label }}" class="form-label">Medida Zipper (cm)</label>
                                        {{ form.sellado_zipper_medida }}
                                        {% if form.sellado_zipper_medida.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_zipper_medida.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_valvula_tipo.id_for_label }}" class="form-label">Tipo Válvula</label>
                                        {{ form.sellado_valvula_tipo }}
                                        {% if form.sellado_valvula_tipo.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_valvula_tipo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.sellado_valvula_medida.id_for_label }}" class="form-label">Medida Válvula (cm)</label>
                                        {{ form.sellado_valvula_medida }}
                                        {% if form.sellado_valvula_medida.errors %}
                                        <div class="invalid-feedback">{{ form.sellado_valvula_medida.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.sellado_ultrasonido }}
                                            <label class="form-check-label" for="{{ form.sellado_ultrasonido.id_for_label }}">
                                                Ultrasonido
                                            </label>
                                        </div>
                                        {% if form.sellado_ultrasonido.value %}
                                        <div class="mt-2">
                                            <label for="{{ form.sellado_ultrasonido_pos.id_for_label }}" class="form-label">Posición Ultrasonido</label>
                                            {{ form.sellado_ultrasonido_pos }}
                                            {% if form.sellado_ultrasonido_pos.errors %}
                                            <div class="invalid-feedback">{{ form.sellado_ultrasonido_pos.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.sellado_precorte }}
                                            <label class="form-check-label" for="{{ form.sellado_precorte.id_for_label }}">
                                                Precorte
                                            </label>
                                        </div>
                                        {% if form.sellado_precorte.value %}
                                        <div class="mt-2">
                                            <label for="{{ form.sellado_precorte_medida.id_for_label }}" class="form-label">Medida Precorte (cm)</label>
                                            {{ form.sellado_precorte_medida }}
                                            {% if form.sellado_precorte_medida.errors %}
                                            <div class="invalid-feedback">{{ form.sellado_precorte_medida.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Otros Detalles #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Otros Detalles</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.lamina.id_for_label }}" class="form-label">Lámina</label>
                                        {{ form.lamina }}
                                        {% if form.lamina.errors %}
                                        <div class="invalid-feedback">{{ form.lamina.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.tratamiento.id_for_label }}" class="form-label">Tratamiento</label>
                                        {{ form.tratamiento }}
                                        {% if form.tratamiento.errors %}
                                        <div class="invalid-feedback">{{ form.tratamiento.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.pistas.id_for_label }}" class="form-label">Pistas</label>
                                        {{ form.pistas }}
                                        {% if form.pistas.errors %}
                                        <div class="invalid-feedback">{{ form.pistas.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="{{ form.programa_lamina.id_for_label }}" class="form-label">Programa Lámina</label>
                                        {{ form.programa_lamina }}
                                        {% if form.programa_lamina.errors %}
                                        <div class="invalid-feedback">{{ form.programa_lamina.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.cantidad_xml.id_for_label }}" class="form-label">XML Cantidad</label>
                                        {{ form.cantidad_xml }}
                                        {% if form.cantidad_xml.errors %}
                                        <div class="invalid-feedback">{{ form.cantidad_xml.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check mt-4">
                                            {{ form.extrusion_doble }}
                                            <label class="form-check-label" for="{{ form.extrusion_doble.id_for_label }}">
                                                Extrusión Doble
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {# Información Contable #}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Información Contable</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="{{ form.cuenta_contable.id_for_label }}" class="form-label">Cuenta Contable</label>
                                        {{ form.cuenta_contable }}
                                        {% if form.cuenta_contable.errors %}
                                        <div class="invalid-feedback">{{ form.cuenta_contable.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.servicio.id_for_label }}" class="form-label">Servicio</label>
                                        {{ form.servicio }}
                                        {% if form.servicio.errors %}
                                        <div class="invalid-feedback">{{ form.servicio.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Dynamic subcategories based on category selection
    const categorySelect = document.getElementById('{{ form.categoria.id_for_label }}');
    const subcategorySelect = document.getElementById('{{ form.subcategoria.id_for_label }}');

    if (categorySelect && subcategorySelect) {
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            if (categoryId) {
                fetch(`/api/subcategorias-por-categoria/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        subcategorySelect.innerHTML = '<option value="">---------</option>';
                        data.forEach(subcategoria => {
                            const option = new Option(subcategoria.nombre, subcategoria.id);
                            subcategorySelect.add(option);
                        });
                    });
            } else {
                subcategorySelect.innerHTML = '<option value="">---------</option>';
            }
        });
    }

    // Toggle fields based on checkbox values
    function toggleField(checkboxId, fieldId) {
        const checkbox = document.getElementById(checkboxId);
        const field = document.getElementById(fieldId);
        const fieldContainer = field.closest('.mt-2');

        if (checkbox && field && fieldContainer) {
            checkbox.addEventListener('change', function() {
                fieldContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    field.value = '';
                }
            });
            // Initial state
            fieldContainer.style.display = checkbox.checked ? 'block' : 'none';
        }
    }

    // Set up toggles for ultrasonido and precorte
    toggleField('{{ form.sellado_ultrasonido.id_for_label }}', '{{ form.sellado_ultrasonido_pos.id_for_label }}');
    toggleField('{{ form.sellado_precorte.id_for_label }}', '{{ form.sellado_precorte_medida.id_for_label }}');

    // Initialize all select2 fields
    document.querySelectorAll('select').forEach(select => {
        if (select.classList.contains('select2')) {
            $(select).select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        }
    });
</script>
{% endblock %}
{% endblock %}