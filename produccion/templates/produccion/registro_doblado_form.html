{% extends "produccion/layouts/produccion_base.html" %}
{% load widget_tweaks %}

{% block title %}{{ page_title|default:"Nuevo Registro de Doblado" }} - ARCOPACK{% endblock %}

{% block page_title %}{{ page_title|default:"Nuevo Registro de Doblado" }}{% endblock %}

{% block produccion_content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-fold me-2"></i>{{ page_title|default:"Nuevo Registro de Doblado" }}
            </div>
            <div class="card-body">
                <form method="post" id="registroDobladoForm">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.orden_produccion.label_tag }}
                                {% render_field form.orden_produccion class="form-control" %}
                                {% if form.orden_produccion.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.orden_produccion.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.maquina.label_tag }}
                                {% render_field form.maquina class="form-control" %}
                                {% if form.maquina.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.maquina.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.operario_principal.label_tag }}
                                {% render_field form.operario_principal class="form-control" %}
                                {% if form.operario_principal.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.operario_principal.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.fecha.label_tag }}
                                {% render_field form.fecha class="form-control" %}
                                {% if form.fecha.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.fecha.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.hora_inicio.label_tag }}
                                {% render_field form.hora_inicio class="form-control" %}
                                {% if form.hora_inicio.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.hora_inicio.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.hora_final.label_tag }}
                                {% render_field form.hora_final class="form-control" %}
                                {% if form.hora_final.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.hora_final.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.cantidad_programada_kg.label_tag }}
                                {% render_field form.cantidad_programada_kg class="form-control" %}
                                {% if form.cantidad_programada_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.cantidad_programada_kg.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.medida_doblado_cm.label_tag }}
                                {% render_field form.medida_doblado_cm class="form-control" %}
                                {% if form.medida_doblado_cm.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.medida_doblado_cm.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ form.observaciones.label_tag }}
                                {% render_field form.observaciones class="form-control" %}
                                {% if form.observaciones.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.observaciones.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Paros Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-pause-circle me-2"></i>Paros</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="abrirModalParo()">
                                    <i class="fas fa-pause-circle me-2"></i>Registrar Paro
                                </button>
                            </div>
                            <div id="paros-registrados" class="mt-3">
                                <!-- Aquí se mostrarán los paros registrados -->
                            </div>
                        </div>
                    </div>

                    <!-- Consumo de WIP Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-recycle me-2"></i>Consumo de WIP</h4>
                        </div>
                        <div class="card-body">
                            {{ consumo_wip_formset.management_form }}
                            <div id="consumo-wip-forms">
                                {% for form in consumo_wip_formset %}
                                <div class="consumo-wip-form mb-3 border p-3" style="{% if form.DELETE.value %}display: none;{% endif %}">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.lote_consumido.label }}</label>
                                                {% render_field form.lote_consumido class="form-control" %}
                                                {% if form.lote_consumido.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.lote_consumido.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_kg_consumida.label }}</label>
                                                {% render_field form.cantidad_kg_consumida class="form-control" %}
                                                {% if form.cantidad_kg_consumida.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_kg_consumida.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <div class="d-flex align-items-end">
                                                    {% if consumo_wip_formset.can_delete %}
                                                        <div class="form-check">
                                                            {% render_field form.DELETE class="form-check-input" %}
                                                            <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-secondary" id="add-consumo-wip">
                                <i class="fas fa-plus me-2"></i>Agregar Consumo WIP
                            </button>
                        </div>
                    </div>

                    <!-- Consumo de MP Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-box me-2"></i>Consumo de Materia Prima</h4>
                        </div>
                        <div class="card-body">
                            {{ consumo_mp_formset.management_form }}
                            <div id="consumo-mp-forms">
                                {% for form in consumo_mp_formset %}
                                <div class="consumo-mp-form mb-3 border p-3" style="{% if form.DELETE.value %}display: none;{% endif %}">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.lote_consumido.label }}</label>
                                                {% render_field form.lote_consumido class="form-control" %}
                                                {% if form.lote_consumido.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.lote_consumido.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_consumida.label }}</label>
                                                {% render_field form.cantidad_consumida class="form-control" %}
                                                {% if form.cantidad_consumida.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_consumida.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <div class="d-flex align-items-end">
                                                    {% if consumo_mp_formset.can_delete %}
                                                        <div class="form-check">
                                                            {% render_field form.DELETE class="form-check-input" %}
                                                            <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-secondary" id="add-consumo-mp">
                                <i class="fas fa-plus me-2"></i>Agregar Consumo MP
                            </button>
                        </div>
                    </div>

                    <!-- Producción Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-dark">
                            <h4><i class="fas fa-boxes me-2"></i>Rollos Producidos</h4>
                        </div>
                        <div class="card-body">
                            {{ produccion_formset.management_form }}
                            <div id="produccion-forms">
                                {% for form in produccion_formset %}
                                <div class="produccion-form mb-3 border p-3" style="{% if form.DELETE.value %}display: none;{% endif %}">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.lote_id.label }}</label>
                                                {% render_field form.lote_id class="form-control" %}
                                                {% if form.lote_id.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.lote_id.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_producida_primaria.label }}</label>
                                                {% render_field form.cantidad_producida_primaria class="form-control" %}
                                                {% if form.cantidad_producida_primaria.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_producida_primaria.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_producida_secundaria.label }}</label>
                                                {% render_field form.cantidad_producida_secundaria class="form-control" %}
                                                {% if form.cantidad_producida_secundaria.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_producida_secundaria.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.ubicacion.label }}</label>
                                                {% render_field form.ubicacion class="form-control" %}
                                                {% if form.ubicacion.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.ubicacion.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <div class="d-flex align-items-end">
                                                    {% if produccion_formset.can_delete %}
                                                        <div class="form-check">
                                                            {% render_field form.DELETE class="form-check-input" %}
                                                            <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-secondary" id="add-produccion">
                                <i class="fas fa-plus me-2"></i>Agregar Lote Producido
                            </button>
                        </div>
                    </div>

                    <!-- Desperdicios Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-trash me-2"></i>Desperdicios</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="abrirModalDesperdicio()">
                                    <i class="fas fa-trash me-2"></i>Registrar Desperdicio
                                </button>
                            </div>
                            <div id="desperdicios-registrados" class="mt-3">
                                <!-- Aquí se mostrarán los desperdicios registrados -->
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ cancel_url }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Paro -->
<div class="modal fade" id="modalParo" tabindex="-1" aria-labelledby="modalParoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalParoLabel">
                    <i class="fas fa-pause-circle me-2"></i>Registrar Paro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formParo">
                    <div class="mb-3">
                        <label for="maquinaParo" class="form-label">
                            Máquina 
                            <span class="text-muted small">(Se usa la máquina seleccionada en el registro)</span>
                        </label>
                        <select class="form-control" id="maquinaParo" required>
                            <option value="">Seleccionar...</option>
                            {% for maquina in form.maquina.field.queryset %}
                                <option value="{{ maquina.pk }}">{{ maquina.codigo }} - {{ maquina.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="causaParo" class="form-label">
                            Causa del Paro
                            <a href="{% url 'configuracion_web:causa-paro-list' %}" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-info ms-2" 
                               title="Gestionar causas de paro">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </label>
                        <select class="form-control" id="causaParo" required>
                            <option value="">Seleccionar...</option>
                            {% for causa in causas_paro %}
                                <option value="{{ causa.pk }}" data-tipo="{{ causa.tipo }}">
                                    {{ causa.codigo }} - {{ causa.descripcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="horaInicioParo" class="form-label">Hora Inicio Paro</label>
                        <input type="datetime-local" class="form-control" id="horaInicioParo" required>
                    </div>
                    <div class="mb-3">
                        <label for="horaFinalParo" class="form-label">Hora Final Paro</label>
                        <input type="datetime-local" class="form-control" id="horaFinalParo" required>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesParo" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesParo" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="registrarParo()">Registrar Paro</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Desperdicio -->
<div class="modal fade" id="modalDesperdicio" tabindex="-1" aria-labelledby="modalDesperdicioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDesperdicioLabel">
                    <i class="fas fa-trash me-2"></i>Registrar Desperdicio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formDesperdicio">
                    <div class="mb-3">
                        <label for="tipoMaterial" class="form-label">Tipo de Material</label>
                        <select class="form-control" id="tipoMaterial" required>
                            <option value="">Seleccionar...</option>
                            <option value="WIP">Producto en Proceso (WIP)</option>
                            <option value="MP">Materia Prima</option>
                            <option value="PT">Producto Terminado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadDesperdicio" class="form-label">Cantidad (kg)</label>
                        <input type="number" class="form-control" id="cantidadDesperdicio" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivoDesperdicio" class="form-label">Motivo del Desperdicio</label>
                        <select class="form-control" id="motivoDesperdicio" required>
                            <option value="">Seleccionar...</option>
                            <option value="defecto_doblado">Defecto en doblado</option>
                            <option value="material_defectuoso">Material defectuoso</option>
                            <option value="error_operario">Error de operario</option>
                            <option value="falla_maquina">Falla de máquina</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesDesperdicio" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesDesperdicio" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="registrarDesperdicio()">Registrar Desperdicio</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para configurar manejo de formsets
        function setupFormsetManagement(formsetPrefix, containerSelector, addButtonSelector, formClass) {
            const container = document.querySelector(containerSelector);
            const addButton = document.querySelector(addButtonSelector);
            const totalForms = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);
            
            if (!container || !addButton || !totalForms) return;
            
            addButton.addEventListener('click', function() {
                const formCount = parseInt(totalForms.value);
                const emptyForm = container.querySelector(`.${formClass}`).cloneNode(true);
                
                // Actualizar los nombres e IDs de los campos del nuevo formulario
                const formRegex = new RegExp(`${formsetPrefix}-(\\d+)-`, 'g');
                emptyForm.innerHTML = emptyForm.innerHTML.replace(formRegex, `${formsetPrefix}-${formCount}-`);
                
                // Limpiar los valores del nuevo formulario
                const inputs = emptyForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.name && !input.name.includes('DELETE')) {
                        input.value = '';
                    }
                });
                
                // Mostrar el formulario
                emptyForm.style.display = 'block';
                
                // Agregar el nuevo formulario al contenedor
                container.appendChild(emptyForm);
                
                // Actualizar el contador de formularios
                totalForms.value = formCount + 1;
                
                // Agregar funcionalidad de eliminar al nuevo formulario
                setupDeleteButton(emptyForm);
            });
        }

        function setupDeleteButton(formElement) {
            const deleteCheckbox = formElement.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                const deleteLabel = formElement.querySelector('label[for="' + deleteCheckbox.id + '"]');
                if (deleteLabel) {
                    deleteLabel.addEventListener('click', function() {
                        if (deleteCheckbox.checked) {
                            formElement.style.display = 'none';
                        } else {
                            formElement.style.display = 'block';
                        }
                    });
                }
            }
        }

        // Configurar manejo de formsets con los prefijos correctos
        setupFormsetManagement('paro_formset', '#paro-forms', '#add-paro', 'paro-form');
        setupFormsetManagement('consumo_wip_formset', '#consumo-wip-forms', '#add-consumo-wip', 'consumo-wip-form');
        setupFormsetManagement('consumo_mp_formset', '#consumo-mp-forms', '#add-consumo-mp', 'consumo-mp-form');
        setupFormsetManagement('produccion_formset', '#produccion-forms', '#add-produccion', 'produccion-form');

        // Configurar botones de eliminar existentes
        document.querySelectorAll('.paro-form, .consumo-wip-form, .consumo-mp-form, .produccion-form').forEach(setupDeleteButton);

        // Inicializar datepicker para el campo de fecha
        if (typeof flatpickr !== 'undefined') {
            flatpickr('#{{ form.fecha.id_for_label }}', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                defaultDate: '{{ form.fecha.value|default:"" }}',
                locale: 'es',
                disableMobile: true
            });

            // Configurar campos de hora
            flatpickr('#{{ form.hora_inicio.id_for_label }}', {
                enableTime: true,
                noCalendar: true,
                dateFormat: 'H:i',
                time_24hr: true,
                defaultDate: '{{ form.hora_inicio.value|default:"" }}',
                locale: 'es'
            });

            flatpickr('#{{ form.hora_final.id_for_label }}', {
                enableTime: true,
                noCalendar: true,
                dateFormat: 'H:i',
                time_24hr: true,
                defaultDate: '{{ form.hora_final.value|default:"" }}',
                locale: 'es'
            });
        }
    });

    // Variables para desperdicios
    let desperdiciosRegistrados = [];

    // Función para registrar desperdicio
    function registrarDesperdicio() {
        const tipoMaterial = document.getElementById('tipoMaterial').value;
        const cantidad = document.getElementById('cantidadDesperdicio').value;
        const motivo = document.getElementById('motivoDesperdicio').value;
        const observaciones = document.getElementById('observacionesDesperdicio').value;

        if (!tipoMaterial || !cantidad || !motivo) {
            alert('Por favor complete todos los campos obligatorios');
            return;
        }

        const desperdicio = {
            id: Date.now(),
            tipoMaterial: tipoMaterial,
            cantidad: parseFloat(cantidad),
            motivo: motivo,
            observaciones: observaciones,
            fecha: new Date().toLocaleString()
        };

        desperdiciosRegistrados.push(desperdicio);
        actualizarVisualizacionDesperdicios();

        // Limpiar formulario
        document.getElementById('formDesperdicio').reset();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalDesperdicio'));
        modal.hide();
        
        alert('Desperdicio registrado exitosamente');
    }

    // Función para actualizar visualización de desperdicios
    function actualizarVisualizacionDesperdicios() {
        const container = document.getElementById('desperdicios-registrados');
        if (desperdiciosRegistrados.length === 0) {
            container.innerHTML = '';
            return;
        }

        let html = '<div class="mt-3"><h6>Desperdicios Registrados:</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>Tipo</th><th>Cantidad</th><th>Motivo</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
        
        desperdiciosRegistrados.forEach(desperdicio => {
            html += `<tr>
                <td>${desperdicio.tipoMaterial}</td>
                <td>${desperdicio.cantidad} kg</td>
                <td>${desperdicio.motivo}</td>
                <td>${desperdicio.fecha}</td>
                <td><button class="btn btn-sm btn-danger" onclick="eliminarDesperdicio(${desperdicio.id})">Eliminar</button></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Función para eliminar un desperdicio
    function eliminarDesperdicio(id) {
        if (confirm('¿Está seguro de eliminar este desperdicio?')) {
            desperdiciosRegistrados = desperdiciosRegistrados.filter(d => d.id !== id);
            actualizarVisualizacionDesperdicios();
            alert('Desperdicio eliminado');
        }
    }

    // Variables para paros
    let parosRegistrados = [];

    // Función para registrar paro
    function registrarParo() {
        const causa = document.getElementById('causaParo').value;
        const horaInicio = document.getElementById('horaInicioParo').value;
        const horaFin = document.getElementById('horaFinalParo').value;
        const observaciones = document.getElementById('observacionesParo').value;

        if (!causa || !horaInicio || !horaFin) {
            alert('Por favor complete todos los campos obligatorios');
            return;
        }

        const paro = {
            id: Date.now(),
            causa: causa,
            horaInicio: horaInicio,
            horaFin: horaFin,
            observaciones: observaciones,
            fecha: new Date().toLocaleString()
        };

        parosRegistrados.push(paro);
        actualizarVisualizacionParos();

        // Limpiar formulario
        document.getElementById('formParo').reset();
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalParo'));
        modal.hide();
        
        alert('Paro registrado exitosamente');
    }

    // Función para actualizar visualización de paros
    function actualizarVisualizacionParos() {
        const container = document.getElementById('paros-registrados');
        if (parosRegistrados.length === 0) {
            container.innerHTML = '';
            return;
        }

        let html = '<div class="mt-3"><h6>Paros Registrados:</h6>';
        html += '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>Causa</th><th>Hora Inicio</th><th>Hora Fin</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
        
        parosRegistrados.forEach(paro => {
            html += `<tr>
                <td>${paro.causa}</td>
                <td>${paro.horaInicio}</td>
                <td>${paro.horaFin}</td>
                <td>${paro.fecha}</td>
                <td><button class="btn btn-sm btn-danger" onclick="eliminarParo(${paro.id})">Eliminar</button></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Función para eliminar un paro
    function eliminarParo(id) {
        if (confirm('¿Está seguro de eliminar este paro?')) {
            parosRegistrados = parosRegistrados.filter(p => p.id !== id);
            actualizarVisualizacionParos();
            alert('Paro eliminado');
        }
    }

    // Función para abrir modal de paro
    function abrirModalParo() {
        const modal = new bootstrap.Modal(document.getElementById('modalParo'));
        modal.show();
        document.getElementById('formParo').reset();
        
        // Configurar la máquina por defecto basada en la seleccionada en el registro principal
        const maquinaRegistro = document.getElementById('{{ form.maquina.id_for_label }}').value;
        if (maquinaRegistro) {
            document.getElementById('maquinaParo').value = maquinaRegistro;
        }
        
        // Configurar hora inicial por defecto (hora actual)
        const ahora = new Date();
        const fechaHoraActual = ahora.toISOString().slice(0, 16);
        document.getElementById('horaInicioParo').value = fechaHoraActual;
    }

    // Función para abrir modal de desperdicio
    function abrirModalDesperdicio() {
        const modal = new bootstrap.Modal(document.getElementById('modalDesperdicio'));
        modal.show();
        document.getElementById('formDesperdicio').reset();
    }
</script>
{% endblock %}