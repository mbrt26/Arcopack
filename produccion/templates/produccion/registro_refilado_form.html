{% extends "produccion/layouts/produccion_base.html" %}
{% load widget_tweaks %}

{% block title %}Nuevo Registro de Refilado - ARCOPACK{% endblock %}

{% block page_title %}{{ page_title|default:"Nuevo Registro de Refilado" }}{% endblock %}

{% block produccion_content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-cut me-2"></i>Nuevo Registro de Refilado
            </div>
            <div class="card-body">
                <form method="post" id="registroRefiladoForm">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.orden_produccion.label_tag }}
                                {% render_field form.orden_produccion class="form-control" %}
                                {% if form.orden_produccion.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.orden_produccion.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.maquina.label_tag }}
                                {% render_field form.maquina class="form-control" %}
                                {% if form.maquina.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.maquina.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.operario_principal.label_tag }}
                                {% render_field form.operario_principal class="form-control" %}
                                {% if form.operario_principal.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.operario_principal.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.fecha.label_tag }}
                                {% render_field form.fecha class="form-control" %}
                                {% if form.fecha.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.fecha.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.hora_inicio.label_tag }}
                                {% render_field form.hora_inicio class="form-control" %}
                                {% if form.hora_inicio.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.hora_inicio.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.hora_final.label_tag }}
                                {% render_field form.hora_final class="form-control" %}
                                {% if form.hora_final.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.hora_final.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.kg_producidos.label_tag }}
                                {% render_field form.kg_producidos class="form-control" %}
                                {% if form.kg_producidos.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.kg_producidos.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.pistas.label_tag }}
                                {% render_field form.pistas class="form-control" %}
                                {% if form.pistas.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.pistas.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ form.observaciones.label_tag }}
                                {% render_field form.observaciones class="form-control" %}
                                {% if form.observaciones.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.observaciones.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Paros Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-pause-circle me-2"></i>Paros</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="abrirModalParo()">
                                    <i class="fas fa-pause-circle me-2"></i>Registrar Paro
                                </button>
                            </div>
                            <div id="paros-registrados" class="mt-3">
                                <!-- Aquí se mostrarán los paros registrados -->
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-trash me-2"></i>Desperdicios</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="abrirModalDesperdicio()">
                                    <i class="fas fa-trash me-2"></i>Registrar Desperdicio
                                </button>
                            </div>
                            <div id="desperdicios-registrados" class="mt-3">
                                <!-- Aquí se mostrarán los desperdicios registrados -->
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h4><i class="fas fa-recycle me-2"></i>Consumo de WIP</h4>
                        </div>
                        <div class="card-body">
                            {{ consumo_wip_formset.management_form }}
                            <div id="consumo-wip-forms">
                                {% for form in consumo_wip_formset %}
                                <div class="consumo-wip-form mb-3 border p-3" style="{% if form.DELETE.value %}display: none;{% endif %}">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.lote_consumido.label }}</label>
                                                {% render_field form.lote_consumido class="form-control" %}
                                                {% if form.lote_consumido.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.lote_consumido.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_kg_consumida.label }}</label>
                                                {% render_field form.cantidad_kg_consumida class="form-control" %}
                                                {% if form.cantidad_kg_consumida.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_kg_consumida.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <div class="d-flex align-items-end">
                                                    {% if consumo_wip_formset.can_delete %}
                                                        <div class="form-check">
                                                            {% render_field form.DELETE class="form-check-input" %}
                                                            <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-secondary" id="add-consumo-wip">
                                <i class="fas fa-plus me-2"></i>Agregar Consumo WIP
                            </button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h4><i class="fas fa-boxes me-2"></i>Cantidades Producidas</h4>
                        </div>
                        <div class="card-body">
                            {{ produccion_formset.management_form }}
                            <div id="produccion-forms">
                                {% for form in produccion_formset %}
                                <div class="produccion-form mb-3 border p-3">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.lote_id.label }}</label>
                                                {% render_field form.lote_id class="form-control" %}
                                                {% if form.lote_id.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.lote_id.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_producida_primaria.label }}</label>
                                                {% render_field form.cantidad_producida_primaria class="form-control" %}
                                                {% if form.cantidad_producida_primaria.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_producida_primaria.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.cantidad_producida_secundaria.label }}</label>
                                                {% render_field form.cantidad_producida_secundaria class="form-control" %}
                                                {% if form.cantidad_producida_secundaria.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.cantidad_producida_secundaria.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.ubicacion.label }}</label>
                                                {% render_field form.ubicacion class="form-control" %}
                                                {% if form.ubicacion.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.ubicacion.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <div class="d-flex align-items-end">
                                                    {% if produccion_formset.can_delete %}
                                                        <div class="form-check">
                                                            {% render_field form.DELETE class="form-check-input" %}
                                                            <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">
                                                                Eliminar
                                                            </label>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-2">
                                                <label class="form-label">{{ form.observaciones.label }}</label>
                                                {% render_field form.observaciones class="form-control" %}
                                                {% if form.observaciones.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.observaciones.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-success" id="add-produccion">
                                <i class="fas fa-plus me-2"></i>Agregar Lote Producido
                            </button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ cancel_url }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Desperdicio -->
<div class="modal fade" id="modalDesperdicio" tabindex="-1" aria-labelledby="modalDesperdicioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDesperdicioLabel">
                    <i class="fas fa-trash me-2"></i>Registrar Desperdicio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formDesperdicio">
                    <div class="mb-3">
                        <label for="tipoMaterial" class="form-label">Tipo de Material</label>
                        <select class="form-control" id="tipoMaterial" required>
                            <option value="">Seleccionar...</option>
                            <option value="WIP">Producto en Proceso (WIP)</option>
                            <option value="MP">Materia Prima</option>
                            <option value="PT">Producto Terminado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadDesperdicio" class="form-label">Cantidad (kg)</label>
                        <input type="number" class="form-control" id="cantidadDesperdicio" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivoDesperdicio" class="form-label">Motivo del Desperdicio</label>
                        <select class="form-control" id="motivoDesperdicio" required>
                            <option value="">Seleccionar...</option>
                            <option value="defecto_calidad">Defecto de Calidad</option>
                            <option value="error_operacion">Error de Operación</option>
                            <option value="falla_maquina">Falla de Máquina</option>
                            <option value="material_defectuoso">Material Defectuoso</option>
                            <option value="cambio_referencia">Cambio de Referencia</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesDesperdicio" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesDesperdicio" rows="3" placeholder="Detalles adicionales sobre el desperdicio"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="registrarDesperdicio()">
                    <i class="fas fa-save me-2"></i>Registrar Desperdicio
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Paro -->
<div class="modal fade" id="modalParo" tabindex="-1" aria-labelledby="modalParoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalParoLabel">
                    <i class="fas fa-pause-circle me-2"></i>Registrar Paro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formParo">
                    <div class="mb-3">
                        <label for="maquinaParo" class="form-label">
                            Máquina 
                            <span class="text-muted small">(Se usa la máquina seleccionada en el registro)</span>
                        </label>
                        <select class="form-control" id="maquinaParo" required>
                            <option value="">Seleccionar...</option>
                            {% for maquina in form.maquina.field.queryset %}
                                <option value="{{ maquina.pk }}">{{ maquina.codigo }} - {{ maquina.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="causaParo" class="form-label">
                            Causa del Paro
                            <a href="{% url 'configuracion_web:causa-paro-list' %}" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-info ms-2" 
                               title="Gestionar causas de paro">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </label>
                        <select class="form-control" id="causaParo" required>
                            <option value="">Seleccionar...</option>
                            {% for causa in causas_paro %}
                                <option value="{{ causa.pk }}" data-tipo="{{ causa.tipo }}">
                                    {{ causa.codigo }} - {{ causa.descripcion }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="horaInicioParo" class="form-label">Hora Inicio Paro</label>
                        <input type="datetime-local" class="form-control" id="horaInicioParo" required>
                    </div>
                    <div class="mb-3">
                        <label for="horaFinalParo" class="form-label">Hora Final Paro</label>
                        <input type="datetime-local" class="form-control" id="horaFinalParo" required>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesParo" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesParo" rows="3" placeholder="Detalles adicionales sobre el paro"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="registrarParo()">
                    <i class="fas fa-save me-2"></i>Registrar Paro
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Funcionalidad para agregar/eliminar formularios dinámicamente
        function setupFormsetManagement(prefix, containerSelector, addButtonSelector, formClass) {
            const container = document.querySelector(containerSelector);
            const addButton = document.querySelector(addButtonSelector);
            
            if (!container || !addButton) {
                console.warn(`Formset setup failed: container(${containerSelector}) or button(${addButtonSelector}) not found`);
                return;
            }

            addButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const totalForms = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
                if (!totalForms) {
                    console.error(`TOTAL_FORMS field not found: #id_${prefix}-TOTAL_FORMS`);
                    return;
                }
                
                const formCount = parseInt(totalForms.value);
                const existingForms = container.querySelectorAll(`.${formClass}`);
                
                if (existingForms.length === 0) {
                    console.error(`No existing forms found with class: ${formClass}`);
                    return;
                }
                
                const newForm = existingForms[0].cloneNode(true);
                
                // Actualizar los nombres e IDs de los campos del nuevo formulario
                const formRegex = new RegExp(`${prefix}-(\\d+)-`, 'g');
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `${prefix}-${formCount}-`);
                
                // Limpiar los valores del nuevo formulario
                const inputs = newForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.name && !input.name.includes('DELETE')) {
                        input.value = '';
                    }
                });
                
                // Agregar el nuevo formulario al contenedor
                container.appendChild(newForm);
                
                // Actualizar el contador de formularios
                totalForms.value = formCount + 1;
                
                // Agregar funcionalidad de eliminar al nuevo formulario
                setupDeleteButton(newForm);
            });
        }

        function setupDeleteButton(formElement) {
            const deleteCheckbox = formElement.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                const deleteLabel = formElement.querySelector('label[for="' + deleteCheckbox.id + '"]');
                if (deleteLabel) {
                    deleteLabel.addEventListener('click', function() {
                        if (deleteCheckbox.checked) {
                            formElement.style.display = 'none';
                        } else {
                            formElement.style.display = 'block';
                        }
                    });
                }
            }
        }

        // Configurar manejo de formsets con los prefijos correctos
        setupFormsetManagement('consumo_wip_formset', '#consumo-wip-forms', '#add-consumo-wip', 'consumo-wip-form');
        setupFormsetManagement('produccion_formset', '#produccion-forms', '#add-produccion', 'produccion-form');

        // Configurar botones de eliminar existentes
        document.querySelectorAll('.paro-form, .consumo-wip-form, .produccion-form').forEach(setupDeleteButton);

        // Inicializar datepicker para el campo de fecha
        if (typeof flatpickr !== 'undefined') {
            flatpickr('#{{ form.fecha.id_for_label }}', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                defaultDate: '{{ form.fecha.value|default:"" }}',
                locale: 'es',
                disableMobile: true
            });

            // Configurar campos de hora
            flatpickr('#{{ form.hora_inicio.id_for_label }}', {
                enableTime: true,
                noCalendar: true,
                dateFormat: 'H:i',
                time_24hr: true,
                defaultDate: '{{ form.hora_inicio.value|default:"" }}',
                locale: 'es'
            });

            flatpickr('#{{ form.hora_final.id_for_label }}', {
                enableTime: true,
                noCalendar: true,
                dateFormat: 'H:i',
                time_24hr: true,
                defaultDate: '{{ form.hora_final.value|default:"" }}',
                locale: 'es'
            });
        }
    });

    // Array para almacenar los desperdicios registrados temporalmente
    let desperdiciosRegistrados = [];

    // Función para abrir el modal de desperdicio
    function abrirModalDesperdicio() {
        const modal = new bootstrap.Modal(document.getElementById('modalDesperdicio'));
        modal.show();
        
        // Limpiar formulario
        document.getElementById('formDesperdicio').reset();
    }

    // Función para registrar un desperdicio
    function registrarDesperdicio() {
        const tipoMaterial = document.getElementById('tipoMaterial').value;
        const cantidad = document.getElementById('cantidadDesperdicio').value;
        const motivo = document.getElementById('motivoDesperdicio').value;
        const observaciones = document.getElementById('observacionesDesperdicio').value;

        // Validar campos requeridos
        if (!tipoMaterial || !cantidad || !motivo) {
            alert('Por favor, complete todos los campos requeridos.');
            return;
        }

        if (parseFloat(cantidad) <= 0) {
            alert('La cantidad debe ser mayor a 0.');
            return;
        }

        // Crear objeto desperdicio
        const desperdicio = {
            id: Date.now(), // ID temporal único
            tipoMaterial: tipoMaterial,
            cantidad: parseFloat(cantidad),
            motivo: motivo,
            observaciones: observaciones,
            fecha: new Date().toLocaleString()
        };

        // Agregar al array
        desperdiciosRegistrados.push(desperdicio);

        // Actualizar la visualización
        actualizarVisualizacionDesperdicios();

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalDesperdicio'));
        modal.hide();

        // Mostrar mensaje de éxito
        mostrarMensaje('Desperdicio registrado exitosamente', 'success');
    }

    // Función para actualizar la visualización de desperdicios
    function actualizarVisualizacionDesperdicios() {
        const container = document.getElementById('desperdicios-registrados');
        
        if (desperdiciosRegistrados.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay desperdicios registrados.</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>Tipo</th><th>Cantidad (kg)</th><th>Motivo</th><th>Observaciones</th><th>Acciones</th></tr></thead><tbody>';

        desperdiciosRegistrados.forEach(desperdicio => {
            const motivoTexto = obtenerTextoMotivo(desperdicio.motivo);
            html += `
                <tr>
                    <td><span class="badge bg-${obtenerColorTipo(desperdicio.tipoMaterial)}">${desperdicio.tipoMaterial}</span></td>
                    <td>${desperdicio.cantidad}</td>
                    <td>${motivoTexto}</td>
                    <td>${desperdicio.observaciones || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarDesperdicio(${desperdicio.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Función para eliminar un desperdicio
    function eliminarDesperdicio(id) {
        if (confirm('¿Está seguro de eliminar este desperdicio?')) {
            desperdiciosRegistrados = desperdiciosRegistrados.filter(d => d.id !== id);
            actualizarVisualizacionDesperdicios();
            mostrarMensaje('Desperdicio eliminado', 'info');
        }
    }

    // Funciones auxiliares
    function obtenerTextoMotivo(motivo) {
        const motivos = {
            'defecto_calidad': 'Defecto de Calidad',
            'error_operacion': 'Error de Operación',
            'falla_maquina': 'Falla de Máquina',
            'material_defectuoso': 'Material Defectuoso',
            'cambio_referencia': 'Cambio de Referencia',
            'otro': 'Otro'
        };
        return motivos[motivo] || motivo;
    }

    function obtenerColorTipo(tipo) {
        const colores = {
            'WIP': 'warning',
            'MP': 'info',
            'PT': 'success'
        };
        return colores[tipo] || 'secondary';
    }

    function mostrarMensaje(mensaje, tipo) {
        // Crear un toast/alert temporal
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }

    // Array para almacenar los paros registrados temporalmente
    let parosRegistrados = [];

    // Función para abrir el modal de paro
    function abrirModalParo() {
        const modal = new bootstrap.Modal(document.getElementById('modalParo'));
        modal.show();
        
        // Limpiar formulario
        document.getElementById('formParo').reset();
        
        // Configurar la máquina por defecto basada en la seleccionada en el registro principal
        const maquinaRegistro = document.getElementById('{{ form.maquina.id_for_label }}').value;
        if (maquinaRegistro) {
            document.getElementById('maquinaParo').value = maquinaRegistro;
        }
        
        // Configurar hora inicial por defecto (hora actual)
        const ahora = new Date();
        const fechaHoraActual = ahora.toISOString().slice(0, 16);
        document.getElementById('horaInicioParo').value = fechaHoraActual;
    }

    // Función para registrar un paro
    function registrarParo() {
        const maquina = document.getElementById('maquinaParo').value;
        const causa = document.getElementById('causaParo').value;
        const horaInicio = document.getElementById('horaInicioParo').value;
        const horaFinal = document.getElementById('horaFinalParo').value;
        const observaciones = document.getElementById('observacionesParo').value;

        // Validar campos requeridos
        if (!maquina || !causa || !horaInicio || !horaFinal) {
            alert('Por favor, complete todos los campos requeridos.');
            return;
        }

        // Crear objeto paro
        const paro = {
            id: Date.now(), // ID temporal único
            maquina: maquina,
            causa: causa,
            horaInicio: horaInicio,
            horaFinal: horaFinal,
            observaciones: observaciones,
            fecha: new Date().toLocaleString()
        };

        // Agregar al array
        parosRegistrados.push(paro);

        // Actualizar la visualización
        actualizarVisualizacionParos();

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalParo'));
        modal.hide();

        // Mostrar mensaje de éxito
        mostrarMensaje('Paro registrado exitosamente', 'success');
    }

    // Función para actualizar la visualización de paros
    function actualizarVisualizacionParos() {
        const container = document.getElementById('paros-registrados');
        
        if (parosRegistrados.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay paros registrados.</p>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
        html += '<thead><tr><th>Motivo</th><th>Duración (min)</th><th>Observaciones</th><th>Acciones</th></tr></thead><tbody>';

        parosRegistrados.forEach(paro => {
            html += `
                <tr>
                    <td>${paro.motivo}</td>
                    <td>${paro.duracion}</td>
                    <td>${paro.observaciones || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarParo(${paro.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Función para eliminar un paro
    function eliminarParo(id) {
        if (confirm('¿Está seguro de eliminar este paro?')) {
            parosRegistrados = parosRegistrados.filter(p => p.id !== id);
            actualizarVisualizacionParos();
            mostrarMensaje('Paro eliminado', 'info');
        }
    }
</script>
{% endblock %}
